#### Thesis Results Analysis- FDis and Betadisper ####
###  Gora_Thesis-Results-Analysis_FDis.R
###  by Sarah Gora
###  Date created: March 7, 2022

# set WD
setwd("~/Desktop/Thesis_Data/R Code")

#load packages
install.packages("FD")
library(tidy)
library(FD)
library(readxl)

# load data
All_Traits <- read.csv("~/Desktop/Thesis_Data/ALL_Traits_Datasheet.csv")
View(All_Traits)




###################### Fdis ###############################

# use trait drop data 

# TRAIT DROP MODEL
All_Traits_O_DroppedTraits <- read_excel("~/Desktop/All_Traits_O_DroppedTraits.xlsx")
View(All_Traits_O_DroppedTraits) 

# Subset out TRAIT DROP model, data by species 
DO_Traits_O_Drop <- subset(All_Traits_O_DroppedTraits, Species=="Dichanthelium_oligosanthes")
AP_Traits_O_Drop <- subset(All_Traits_O_DroppedTraits, Species=="Ambrosia_psilostachya")
SM_Traits_O_Drop <- subset(All_Traits_O_DroppedTraits, Species=="Solidago_missouriensis")
AG_Traits_O_Drop <- subset(All_Traits_O_DroppedTraits, Species=="Andropogon_gerardii")
SN_Traits_O_Drop <- subset(All_Traits_O_DroppedTraits, Species=="Sorghastrum_nutans")


#### Subset out N0N10 data for each species 
DO_N0N10_Traits_O_Drop <- subset(DO_Traits_O_Drop, Treatment2 == "0"| Treatment2== "10")
AP_N0N10_Traits_O_Drop <- subset(AP_Traits_O_Drop, Treatment2 == "0"| Treatment2== "10")
SM_N0N10_Traits_O_Drop <- subset(SM_Traits_O_Drop, Treatment2 == "0"| Treatment2== "10")
AG_N0N10_Traits_O_Drop <- subset(AG_Traits_O_Drop, Treatment2 == "0"| Treatment2== "10")
SN_N0N10_Traits_O_Drop <- subset(SN_Traits_O_Drop,Treatment2 == "0"| Treatment2== "10")


#### Subset out Change for each species Ordination data
DO_Ch_Traits_O_Drop <- subset(DO_Traits_O_Drop, Experiment=="Change")
AP_Ch_Traits_O_Drop <- subset(AP_Traits_O_Drop, Experiment=="Change")
SM_Ch_Traits_O_Drop <- subset(SM_Traits_O_Drop, Experiment=="Change")
AG_Ch_Traits_O_Drop <- subset(AG_Traits_O_Drop, Experiment=="Change")
SN_Ch_Traits_O_Drop <- subset(SN_Traits_O_Drop, Experiment=="Change")

# TROPHIC FUNCTIONAL DIVERSITY

### TRY 1 #####

# Read in Data Matrix (TREATMENT by SPECIES matrix)?

plant_trt <- DO_N0N10_Traits_O_Drop %>%
  select(c(7, 8))


# Read in plant traits data matrix (SPECIES by TRAIT matrix)?
# DO Traits, N0N10 with traits dropped 

plant_traits <- DO_N0N10_Traits_O_Drop %>%
                            select(c(8, 10:20))





# Create a gower distance matrix:
MyDist_DO_N0N10_Traits <- gowdis(plant_traits[colnames(plant_trt), ], asym.bin = NULL) # ERROR MESSAGE
DO_N0N10_Traits_matrix <- as.matrix(MyDist_DO_N0N10_Traits)

# Measure FD using the functional dispersion metric:
# fdisp(distance, matrix-of-spec-abund , tol = 1e-07)

# run fdis
DO_N0N10_Traits_fdisp <- fdisp(MyDist_DO_N0N10_Traits, DO_N0N10_Traits_matrix, tol= 1e-07)

# visualize output 
DO_N0N10_Traits_FDis <- DO_N0N10_Traits_fdisp$FDis



# NEXT STEP: 
# Standardize FD values across sites..... ?? would that be across experiments in my data?

# Observed null reproductive FD values:

# Function for generating a random set of FD values

null_DO_N0N10_Traits <-function(x){
    #Function for generating a random set of FD values
    rownames(x)<- sample(rownames(x),length(rownames(x)),replace = FALSE)
    fdisp(gowdis(x[colnames(SALCC_Present_Trophic), ]), as.matrix(SALCC_Present_Trophic))$FDis
  }

  
# Ranked observed null reproductive FD values:

# P-values:

# SES values (Standardized FD values) across sites:









# Calculate Functional Dispersion, FDis 
# Calculate the functional dispersion of clouds of multivariate points

# run FDis then 
# Run betadisper 



##### BETADISPER ##########
######## First Try ####### 

# Betadisper first calculates the average distance of group members
# to the group centroid in multivariate space (generated by a distance matrix). 
# Then, an ANOVA is done to test if the dispersions (variances) of groups are different.



# Betadisper: DO, N0N10

# data selected, distance calculated 
dst2 <- dist(DO_N0N10_Traits_O_Drop[,10:20])

### run Betadisper 
DO_N0N10_bd <- betadisper(dst2, DO_N0N10_Traits_O_Drop$Treatment)
DO_N0N10_bd
permutest(DO_N0N10_bd)
# p= 0.037 *
# F= 4.5292

### Analysis of Variance
anova(DO_N0N10_bd)
# p= 0.04088 *

# adonis 
adonis(Rip_DO_Traits~Treatment, data = DO_N0N10_Traits_O_Drop, permutations = 1000, method = 'bray') 
# p= 0.07493




# Betadisper: AP, N0N10

# data selected, distance calculated 
dst2 <- dist(AP_N0N10_Traits_O_Drop[,10:20])

### run Betadisper 
AP_N0N10_bd <- betadisper(dst2, AP_N0N10_Traits_O_Drop$Treatment)

### Analysis of Variance
anova(AP_N0N10_bd)
# p= 0.6676
# F= 0.1879

# Test for homogeneity of multivariate dispersions
permutest(AP_N0N10_bd)
# p= 0.662 



# Betadisper: SM, N0N10

# data selected, distance calculated 
dst2 <- dist(SM_N0N10_Traits_O_Drop[,10:20])

### run Betadisper -Test for homogeneity of multivariate dispersions
SM_N0N10_bd <- betadisper(dst2, SM_N0N10_Traits_O_Drop$Treatment)
permutest(SM_N0N10_bd)
# p= 0.335
# F=0.9529

### Analysis of Variance
anova(SM_N0N10_bd)
# p= 0.3373





# Betadisper: AG, N0N10

# data selected, distance calculated 
dst2 <- dist(AG_N0N10_Traits_O_Drop[,10:20])

### run Betadisper -Test for homogeneity of multivariate dispersions
AG_N0N10_bd <- betadisper(dst2, AG_N0N10_Traits_O_Drop$Treatment)
permutest(AG_N0N10_bd)
# p= 0.021 *

### Analysis of Variance
anova(AG_N0N10_bd)
# p= 0.02964 * 

# adonis 
adonis(Rip_AG_Traits~Treatment, data = AG_N0N10_Traits_O_Drop, permutations = 1000, method = 'bray') 
# p<0.001 **




# Betadisper: SN, N0N10

# data selected, distance calculated 
dst2 <- dist(SN_N0N10_Traits_O_Drop[,10:20])

### run Betadisper -Test for homogeneity of multivariate dispersions
SN_N0N10_bd <- betadisper(dst2, SN_N0N10_Traits_O_Drop$Treatment)
permutest(SN_N0N10_bd)
# p= 0.565
# F= 0.4133
### Analysis of Variance
anova(SN_N0N10_bd)
# p= 0.5246







########### CHANGE BETADISPER ##########



# Betadisper: DO, Change

# data selected, distance calculated 
dst2 <- dist(DO_Ch_Traits_O_Drop[,10:20])

### run Betadisper 
DO_Ch_bd <- betadisper(dst2, DO_Ch_Traits_O_Drop$Treatment)
DO_Ch_bd
permutest(DO_Ch_bd)
# p= 0.969
# F= 0.0933

### Analysis of Variance
anova(DO_Ch_bd)
# p= 0.9629





# Betadisper: AP, Change

# data selected, distance calculated 
dst2 <- dist(AP_Ch_Traits_O_Drop[,10:20])

### run Betadisper -Test for homogeneity of multivariate dispersions
AP_Ch_bd <- betadisper(dst2, AP_Ch_Traits_O_Drop$Treatment)
AP_Ch_bd
permutest(AP_Ch_bd)
# p= 0.52 
# F= 0.8874 

### Analysis of Variance
anova(AP_Ch_bd)
# p= 0.4654





# Betadisper: SM, Change

# data selected, distance calculated 
dst2 <- dist(SM_Ch_Traits_O_Drop[,10:20])

### run Betadisper-Test for homogeneity of multivariate dispersions 
SM_Ch_bd <- betadisper(dst2, SM_Ch_Traits_O_Drop$Treatment)
SM_Ch_bd
permutest(SM_Ch_bd)
# p= 0.613
# F= 0.6212

### Analysis of Variance
anova(SM_Ch_bd)
# p= 0.6099





# Betadisper: AG, Change

# data selected, distance calculated 
dst2 <- dist(AG_Ch_Traits_O_Drop[,10:20])

### run Betadisper -Test for homogeneity of multivariate dispersions
AG_Ch_bd <- betadisper(dst2, AG_Ch_Traits_O_Drop$Treatment)
AG_Ch_bd
permutest(AG_Ch_bd)
# p= 0.965
# F= 0.0799

### Analysis of Variance
anova(AG_Ch_bd)
# p= 0.9701 




# Betadisper: SN, Change

# data selected, distance calculated 
dst2 <- dist(SN_Ch_Traits_O_Drop[,10:20])

### run Betadisper -Test for homogeneity of multivariate dispersions
SN_Ch_bd <- betadisper(dst2, SN_Ch_Traits_O_Drop$Treatment)
SN_Ch_bd
permutest(SN_Ch_bd)
# p= 0.660
# F= 0.5403

### Analysis of Variance
anova(SN_Ch_bd)
# p= 0.6602







